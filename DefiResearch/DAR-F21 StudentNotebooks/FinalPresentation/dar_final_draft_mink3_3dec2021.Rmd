---
title: "MATP-4910  Final Project Notebook Template"
author: "Kaiwen Min"
date: "3 Dec 2021"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
subtitle: "DAR Project DeFi"
---

```{r setup, include=FALSE}
# Set the default CRAN repository
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})

# Set code chunk defaults
knitr::opts_chunk$set(echo = TRUE)

# Load required packages; install if necessary
# CAUTION: DO NOT interrupt R as it installs packages!!
if (!require("ggplot2")) {
  install.packages("ggplot2")
  library(ggplot2)
}

if (!require("knitr")) {
  install.packages("knitr")
  library(knitr)
}

if (!require("dplyr")) {
  install.packages("dplyr")
  library(dp)
}

if (!require("RColorBrewer")) {
  install.packages("RColorBrewer")
  library(RColorBrewer)
}
if (!require("beeswarm")) {
  install.packages("beeswarm")
  library(beeswarm)
}
if (!require("tidyverse")) {
  install.packages("tidyverse")
  library(tidyverse)
}
if (!require("ggbeeswarm")) {
  install.packages("ggbeeswarm")
  library(ggbeeswarm)
}
if (!require("xts")) {
  install.packages("xts")
  library(xts)
}

if (!require("lubridate")) {
  install.packages("lubridate")
  library(lubridate)
}

if (!require("knitr")) {
  install.packages("knitr")
  library(knitr)
}

if (!require("data.table")) {
  install.packages("data.table")
  library(data.table)
}

```



# Final Project: Github Info



* github repository: https://github.rpi.edu/DataINCITE/IDEA-Blockchain/tree/dar-mink3
* Your github ID: dar-mink3
* Final notebook: dar_final_mink3_3dec2021.Rmd
    
* Issues:
    
    https://github.rpi.edu/DataINCITE/IDEA-Blockchain/issues/99
    
    https://github.rpi.edu/DataINCITE/IDEA-Blockchain/issues/85


# Overview & Problems Tackled

I looked into the borrow rate and borrow amount USD of the top borrowed coins under different borrow rate modes to see if there is a pattern between coins. I also looked into the transactions made by top users with most transaction amount in USD to see their characteristics and if they share any similarities.



# Data Description

I used the transactions.Rds and transactionsv2.rds under Data. transaction.Rds contains 481519 data points of 26 features and transactionsv2.rds contains 745612 data points of 33 features.

# Results

## Problem 1 

What are the patterns of borrow rates and borrow amounts in USD of some top borrowed coins? Do these coins have different patterns under different borrow rate modes?
 
### Methods 

I used transactions.Rds in this problem. First I keep the borrows with borrow rate less than 50 percent and amount USD less than 100 million dollars. Then I got 5 top coins with most number of borrows to take a closer look at the borrow rates and borrow amounts. I used different colors for different coins and two line types for the two borrow modes. I used density plot instead of scalar plot to check the frequency and I used log10 for borrow amount USD to scale the data.
	
### Results

```{r, echo=FALSE, results=FALSE}
# load Rds (binary version of csv file) into dataframe
df <- read_rds('../../Data/transactions.Rds')

df.borrow <- df %>% filter(!is.na(borrowRate)) %>% 
  filter(type == "borrow") %>% 
  filter(borrowRate <= 50) %>% 
  filter(amountUSD <= 100000000) %>%
  filter(1 <= amountUSD)

df.borrow.new2 <- df.borrow %>%
  filter(reserve == "USDC" | reserve == "USDT" | reserve == "DAI" | reserve == "WBTC" | reserve == "TUSD") %>%
  filter(borrowRate <= 20) %>%
  rename(borrowRatePercentage = borrowRate)


ggplot(df.borrow.new2,aes(borrowRatePercentage, color = reserve, linetype = borrowRateMode)) +
  ggtitle("Borrow rate for top borrowed coins")+ 
  geom_density()

ggplot(df.borrow.new2,aes(log10(amountUSD), color = reserve, linetype = borrowRateMode)) +
  ggtitle("Log10 borrow amount in USD for top borrowed coins")+ 
  geom_density()
```

### Discussion

We could see that the top coins generally have a borrow rate of around 4 percent under variable borrow rate mode and about 10 percent under stable borrow rate mode. But we could see that the borrow amount USD is very much the same under variable borrow rate mode and stable borrow rate mode. People tend to borrow around 10^4 dollars per transaction, which is very persuasive as people love round figures.

## Problem 2

What are the patterns for the top users with most transaction total amounts?
 
### Methods

First I counted the users' transactions with weights of amount USD to find out the top 5 users with most total transaction amount USD. Then I plot the number of transactions per week, amount USD of transactions per week and log 10 amount USD of transactions with facet plot for comparison between users. I made a table to find the exact number of numbers of transactions and amount USD of transactions, and whether the user is a protocol contractor. Last, I pick the three users with less number of transactions since they were not clearly visualized in the graph before. I also did a swarm plot for these users.
	
### Results

```{r, echo=FALSE, warning=FALSE}
# load Rds (binary version of csv file) into dataframe
df <- read_rds('../../Data/transactionsv2.rds')

users <- df %>% dplyr::count(user_alias, wt=amountUSD, protocolContract, name = "amountUSD")
top20amountuser <- users[order(users$amountUSD, decreasing = TRUE),]$user_alias[1:20]

df.1users<-filter(df, user_alias %in% top20amountuser[1:5])

df.1users$ymd <- as_datetime(df.1users$timestamp) # fix times for the transactions

setDT(df.1users)[, ymd_new := format(as.Date(ymd), '%Y-%m-%V') ] ## '%Y-%m' for just month-year

df.1user <- df.1users %>% dplyr::count(ymd_new, type, user_alias, protocolContract, name = "amount")

ggplot(df.1user) + 
  geom_bar(aes(x=ymd_new,y= amount, fill = type),
           stat='identity') + ggtitle("User Transactions Weekly for top 5 users with most transactions amount USD") + labs(y = "Number of transactions", x= "Time (Weeks)")+ 
  theme(
           axis.text.x=element_blank(),
           axis.ticks.x=element_blank())+facet_grid(rows = df.1user$user_alias)

df.1user <- df.1users %>% 
  dplyr::count(ymd_new, type, user_alias, wt=amountUSD, name = "amountUSD")

ggplot(df.1user) + 
  geom_bar(aes(x=ymd_new,y= amountUSD, fill = type),
           stat='identity') + ggtitle("User Transactions amountUSD Weekly for top 5 users with most transaction amountUSD") + labs(y = "AmountUSD of transactions", x= "Time (Weeks)")+ 
  theme(
           axis.text.x=element_blank(),
           axis.ticks.x=element_blank())+facet_grid(rows = df.1user$user_alias)

ggplot(df.1user) + 
  geom_bar(aes(x=ymd_new,y= log10(amountUSD), fill = type),
           stat='identity') + ggtitle("User Transactions amountUSD Weekly for top 5 users with most transaction amountUSD") + labs(y = "log10 amountUSD of transactions", x= "Time (Weeks)")+ 
  theme(
           axis.text.x=element_blank(),
           axis.ticks.x=element_blank())+facet_grid(rows = df.1user$user_alias)

df.1user <- df.1users %>% dplyr::count(user_alias, protocolContract, name = "amount")
kable(df.1user)
df.1user <- df.1users %>% 
  dplyr::count(user_alias, wt=amountUSD, protocolContract, name = "amountUSD") 
kable(df.1user)

df.1users<-filter(df, user_alias %in% top20amountuser[2:4])
df.1users$ymd <- as_datetime(df.1users$timestamp) # fix times for the transactions

setDT(df.1users)[, ymd_new := format(as.Date(ymd), '%Y-%m-%V') ] ## '%Y-%m' for just month-year

df.1user <- df.1users %>% dplyr::count(ymd_new, type, user_alias, protocolContract, name = "amount")

ggplot(df.1user) + 
  geom_bar(aes(x=ymd_new,y= amount, fill = type),
           stat='identity') + ggtitle("User Transactions Weekly for top 5 users with most transactions amount USD") + labs(y = "Number of transactions", x= "Time (Weeks)")+ 
  theme(
           axis.text.x=element_blank(),
           axis.ticks.x=element_blank())+facet_grid(rows = df.1user$user_alias)

ggplot(df.1users,aes(user_alias, ymd,color=type)) + 
        geom_beeswarm(cex=1)+
        coord_flip()+
        ggtitle("User Transaction History")

```

### Discussion

There isn't much things in common between the top users as the patterns vary. All of the users deposited and redeemed in huge amounts and had no or little liquidation, but only Shirley Lamberton borrowed a lot of money. Ruth Felan did a higher portion of collateral, and Gladys Marquez who is a protocol contractor had a higher portion of deposit.


# Summary and Recommendations

For the top coins that are borrowed most, different coins share a similar borrow rate under the same borrow rate mode. The coins generally have a borrow rate of around 4 percent under variable borrow rate mode and about 10 percent under stable borrow rate mode. Users tend to have a transaction around 10000 dollars as we may have a favor towards round figures. For typical users I obtained with the most transaction amount in USD, I notice that they do not have much in common. These users all have no or little liquidation and huge amount in borrow and redeem. The only protocol contractor among them have a higher portion of deposit. I would recommend my analysis to be included in an expanded app or paper as I got visualization of the most borrowed coins and typical users. Although it's not much, but I believe some of my graphs clearly show some patterns and able to provide some insights for people that are not familiar with DeFi and cryptocurrencies.

# References



# Appendix






