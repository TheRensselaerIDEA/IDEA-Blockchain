---
title: "vyasj2 Homework5"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Bi-Weekly Work Summary	

* RCS ID: vyasj2
* Project Name: IDEA-Blockchain
* Summary of work for last 2 weeks 

    * Used the transactionsv2 data that Chris provided to run some more survival analysis for the bigger goal of creating a table or chart that depicts coin instability vs liquidation rate.
    
* Summary of github commits 

    * dar-vyasj2
    * https://github.rpi.edu/DataINCITE/IDEA-Blockchain/blob/dar-vyasj2/DefiResearch/StudentNotebooks/analysisv2.Rmd
    * All done by me

## Personal Contribution	

* The idea was to be able to graph coin instability (i.e., fluctuations in price), against the liquidation rate so come up with some meaningful statistics that would help determine when are the most/least dangerous times to borrow, what kind of borrow parameters are the most/least dangerous, and the circumstances that existed when borrow liquidated. 

## Discussion	

* Discuss primary findings: 

    * I wanted to know the relationship between fluctuation of coin price to rate of liquidation 
    * I started by filtering down the dataset to only WETH borrows, since it's not pegged to anything so there should be a good amount of instability, and because ETH is a very commonly used currency. I then graphed the difference between the price of WETH that the borrow was made at and the price of WETH that the borrow was liquidated at. I thought this would be of value because it would show us how the difference in price between these two values changes over time. My idea was that this might show some sort of pattern between the prices which would give us insight into the variability of the price.
    * I then started to graph Kaplan-Meier Survival Curves of the probability of a WETH loan's survival over time based on different factors, like the type of borrow rate (stable or variable), and the principal reserve. My goal with this was to see how different categorical variables might affect the survival rate of a loan over time. There are a lot of things to be seen from the principal reserve graph, as there are a lot of different reserves that each give a different probability over time. I then created a multivariate Cox Proportional-Hazards Model that took into account both of these variables, the type of borrow rate and the principal reserve. It has a very large confidence interval at the middle, indicating that there is a very large variability when we use these two factors to describe the data.
    * The next steps would be to find variables that lower this variability as much as possible, and then make the correlation between fluctuation of reserve price and rate or probability of liquidation.

```{r}
if (!require(readr)) {
  install.packages("readr")
  library(readr)
}
if (!require("ggplot2")) {
  install.packages("ggplot2")
  library(ggplot2)
}
if (!require("lubridate")) {
  install.packages("lubridate")
  library(lubridate)
}
if (!require("dplyr")) {
    install.packages("dplyr")
    library(dplyr)
}
if (!require("roll")) {
  install.packages("roll")
  library(roll)
}
if (!require("survival")) {
  install.packages("survival")
  library(survival)
}
if (!require("ggfortify")) {
  install.packages("ggfortify")
  library(ggfortify)
}
if (!require("tidyr")) {
  install.packages("tidyr")
  library(tidyr)
}
if (!require("survminer")) {
  install.packages("survminer")
  library(survminer)
}
if (!require("plotly")) {
  install.packages("plotly")
  library(plotly)
}
```

```{r}
df <- read_rds("../../Data/transactionsv2.rds")
df <- df %>%
  dplyr::mutate(date=as_datetime(timestamp))
head(df)
```

```{r}
borrows <- df %>%
  dplyr::filter(type=="borrow")

reservePrices <- df %>%
  dplyr::select(reserve,reservePriceUSD,date)

head(reservePrices)
```

```{r}
wethPrice <- reservePrices %>%
  dplyr::filter(reserve=="WETH") %>%
  dplyr::mutate(sdPrice=roll::roll_sd(reservePriceUSD,width=21)) %>%
  dplyr::mutate(avgPrice=roll::roll_mean(reservePriceUSD,width=21))

ggplot(wethPrice,aes(x=date,y=reservePriceUSD)) + geom_line()
ggplot(wethPrice,aes(x=date,y=sdPrice)) + geom_line()
ggplot(wethPrice,aes(x=date,y=avgPrice)) + geom_line()
```

```{r}
liquidations <- df %>%
  dplyr::filter(type=="liquidation")

wethLiquids <- liquidations %>%
  dplyr::filter(collateralReserve=="WETH") %>%
  dplyr::select(user_alias,date,reservePriceUSDPrincipal,timestamp,principalReserve,type,reservePriceUSDCollateral) %>%
  dplyr::rename(user=user_alias)

wethBorrows <- borrows %>% 
  dplyr::filter(reserve=="WETH") %>%
  dplyr::select(onBehalfOf_alias,date,reservePriceUSD,timestamp,borrowRateMode,type) %>%
  dplyr::rename(user=onBehalfOf_alias)
```

```{r}
maxLiquidDate_weth <- max(wethLiquids$timestamp)

wethBorrowLiquids <- left_join(wethBorrows,wethLiquids,by="user") %>%
  dplyr::mutate(date=case_when(is.na(date.y) ~ date.x, TRUE ~ date.y)) %>%
  dplyr::mutate(timestamp=case_when(is.na(timestamp.y) ~ timestamp.x, TRUE ~ timestamp.y)) %>%
  dplyr::mutate(status=case_when(is.na(date.y) ~ 0, TRUE ~ 1)) %>%
  dplyr::mutate(timeDiff=case_when(status==0 ~ maxLiquidDate_weth/86400, status==1 ~ (timestamp.y-timestamp.x)/86400)) %>%
  dplyr::filter(timeDiff>0) %>%
  dplyr::mutate(type=case_when(is.na(type.y) ~ "borrow", TRUE ~ "liquidation")) %>%
  dplyr::mutate(priceDiff=case_when(!is.na(reservePriceUSDCollateral) ~ reservePriceUSDCollateral-reservePriceUSD, TRUE ~ reservePriceUSD)) %>%
  dplyr::filter(priceDiff>0) %>%
  dplyr::select(user,reservePriceUSD,timestamp,date,type,reservePriceUSDPrincipal,principalReserve,timeDiff,status,borrowRateMode,priceDiff)

head(wethBorrowLiquids)

ggplot(wethBorrowLiquids,aes(x=as.Date(date),y=priceDiff)) + 
  geom_line() + 
  ggtitle("Difference Between Price Borrowed at and Price Liquidated at Over Time") + 
  scale_x_date(date_labels="%m-%y") + 
  xlab("Date") + 
  ylab("Price Difference")
```


```{r}
# Regular Survival Analysis

km <- with(wethBorrowLiquids,Surv(timeDiff,status))
head(km,25)
km_fit <- survfit(Surv(timeDiff,status) ~ 1, data=wethBorrowLiquids)
summary(km_fit, times = c(1,30,60,90*(1:10)))
ggsurvplot(km_fit, conf.int = TRUE, xlim = c(0,300), ylim = c(0.85,1)) + 
  ggtitle("Survival Probability of Borrow Until Liquidation Over Time (max. 300 Days)")
```

```{r}
km2 <- with(wethBorrowLiquids,Surv(timeDiff,status))
head(km2,25)
km_fit_brm <- survfit(Surv(timeDiff,status) ~ borrowRateMode, data=wethBorrowLiquids)
summary(km_fit_brm, times = c(1,30,60,90*(1:10)))
ggsurvplot(km_fit_brm, conf.int = TRUE, xlim = c(0,300), ylim = c(0.84,1),break.time.by=25) + 
  ggtitle("Survival Probability of Borrow Until Liquidation Over Time By Borrow Rate Mode (max. 300 Days)")
```

```{r}

km3 <- with(wethBorrowLiquids,Surv(timeDiff,status))
head(km3,25)
km_fit_cr <- survfit(Surv(timeDiff,status) ~ principalReserve, data=wethBorrowLiquids)
summary(km_fit_cr, times = c(1,30,60,90*(1:10)))
ggsurvplot(km_fit_cr) + 
  ggtitle("Survival Probability of Borrow Until Liquidation Over Time By Principal Reserve of Loan")
```

```{r}
cox <- coxph(Surv(timeDiff,status) ~ borrowRateMode + principalReserve, 
             data=wethBorrowLiquids)
summary(cox)
cox_fit <- survfit(cox)
autoplot(cox_fit) + 
  ggtitle("Proportional Hazards Graph of Survival Probability of Borrow Until Liquidation Over Time By Borrow Rate Mode, Principal Reserve of Loan") + 
  xlab("Time") + 
  ylab("Survival Probability")
```