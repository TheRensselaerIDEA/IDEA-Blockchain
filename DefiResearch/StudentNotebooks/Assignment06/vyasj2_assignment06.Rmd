---
title: "DAR F21 Project Status Notebook: "
author: "Jaimin Vyas (vyasj2)"
date: "10/31/2021"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
subtitle: "DeFi"
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Biweekly work summary

* RCS ID: vyasj2
* Project Name: IDEA-Blockchain
* Summary of work for last 2 weeks 


# Personal Contribution

* GitHub commits on branch dar-vyasj2
  * Worked on general survival functions, as well as a little bit of further analysis on liquidations.
* In this notebook, I look a bit deeper into the impact of change in price on rate of liquidation
* Working on solving GitHub Issue #80: Survival approach at the user level

# Discussion of primary findings

* What did you want to know?
  I wanted to see the relationship between rate of liquidation and fluctuation of price, and look at individual user liquidations, and perhaps building off of Roman's work to further analyze these liquidations and what causes them, so that we can model the survival of a borrow better on those variables.
* How did you go about finding it?
  Getting the number of liquidations every day, finding the most statistically significant liquidations by any one specific user, and thinking about how to combine with Roman's work.
* What did you find?


To begin, we install the necessary packages:

```{r}
if (!require("survival")) {
  install.packages("survival")
  library(survival)
}
if (!require("dplyr")) {
  install.packages("dplyr")
  library(dplyr)
}
if (!require("survminer")) {
  install.packages("survminer")
  library(survminer)
}
if (!require("ggplot2")) {
  install.packages("ggplot2")
  library(ggplot2)
}
if (!require("readr")) {
  install.packages("readr")
  library(readr)
}
if (!require("tidyr")) {
  install.packages("tidyr")
  library(tidyr)
}
if (!require(stringr)) {
  install.packages("stringr")
  library("stringr")
}
if (!require(lubridate)) {
  install.packages("lubridate")
  library("lubridate")
}
if (!require(kableExtra)) {
  install.packages("kableExtra")
  library("kableExtra")
}
```

Then, we load the data:

```{r}
df <- read_rds("../../Data/transactionsv2.rds")

df <- df %>%
  dplyr::mutate(date=as_datetime(timestamp))

head(df)
```

We first want to get all of the prices for each reserve and the date at which that price was recorded.

```{r}
reservePrices <- df %>%
  dplyr::select(reserve,reservePriceUSD,date)

head(reservePrices)
```

Now we filter these prices so that we get only WETH prices, and add a rolling average and rolling standard deviation with a 21-day window. This is just so that we can see the fluctuations in price, as well as an average and standard deviation of how the price changes over time.

```{r}
wethPrice <- reservePrices %>%
  dplyr::filter(reserve=="WETH") %>%
  dplyr::mutate(sdPrice=roll::roll_sd(reservePriceUSD,width=21)) %>%
  dplyr::mutate(avgPrice=roll::roll_mean(reservePriceUSD,width=21))

ggplot(wethPrice,aes(x=as.Date(date))) + 
  geom_line(aes(y=reservePriceUSD), colour="red") + 
  geom_line(aes(y=avgPrice), colour="blue") + 
  geom_line(aes(y=sdPrice), colour="green") + 
  ggtitle("WETH Price (red), 21-Day Rolling Avg (blue), and 21-Day Rolling StDev (green)") +
  labs(x="Date", y="Price", colour="Legend")
```

It's immediately visible that the price of WETH is very highly volatile, because the rolling average and standard deviation seem to just be zigzags going back and forth. It is also clear to see that because the red line has a lot of hills and troughs. We won't use the rolling average or standard deviation going forward, because it doesn't seem to show anything that is valuable, other than what price they are centered around. At this point, I was wondering how the number of liquidations was impacted by this high volatility. I was also curious to see what the difference in liquidation price and borrow price was over time, because seeing the differences in prices on certain dates could provide more insight into what kinds of events impact liquidation, since if there is a low difference, then that means the price of WETH when liquidation occurred was not too far off from the initial borrow price. We can try and perform some interesting analyses on the collateral reserve when this happens. 

```{r}
borrows <- df %>%
  dplyr::filter(type=="borrow") %>%
  dplyr::rename(name=onBehalfOf_alias)

liquidations <- df %>%
  dplyr::filter(type=="liquidation") %>%
  dplyr::rename(name=user_alias)

wethLiquids <- liquidations %>%
  dplyr::filter(principalReserve=="WETH") %>%
  dplyr::select(name,date,timestamp,type,liquidator,collateralAmount,collateralReserve,reservePriceUSDCollateral,principalAmount,principalReserve,reservePriceUSDPrincipal)

wethBorrows <- borrows %>% 
  dplyr::filter(reserve=="WETH") %>%
  dplyr::select(name,date,reservePriceUSD,timestamp,borrowRateMode,type)

wethBorrowLiquids <- left_join(wethBorrows,wethLiquids,by="name") %>%
  dplyr::rename(borrowDate=date.x) %>%
  dplyr::rename(liquidationDate=date.y) %>%
  dplyr::mutate(date=case_when(is.na(liquidationDate) ~ borrowDate, TRUE ~ liquidationDate)) %>%
  dplyr::mutate(priceDiff=reservePriceUSDPrincipal-reservePriceUSD) %>%
  dplyr::filter(priceDiff>0)

ggplot(wethBorrowLiquids,aes(x=as.Date(date),y=priceDiff)) + 
  geom_point() + 
  ggtitle("Difference Between Price Borrowed at and Price Liquidated at Over Time") + 
  scale_x_date(date_labels="%m-%y") + 
  xlab("Date") + 
  ylab("Price Difference")
```
We can see that it seems to be fairly sporadic, but there are some clumps where there are a lot of low difference in prices, obviously at the China crypto ban date in May/June, as well as later on around August/September. If we plot this as a line graph and overlay it on the price of WETH, it might provide something more interesting.

```{r}
ggplot() + 
  geom_line(data=wethPrice, aes(x=as.Date(date),y=reservePriceUSD), colour = "red") +
  geom_line(data=wethBorrowLiquids, aes(x=as.Date(date),y=priceDiff), colour = "blue") +  
  scale_x_date(date_labels="%m-%y") + 
  xlab("Date") + 
  ylab("Price (USD)") + 
  ggtitle("Difference in Price Borrowed at and Price Liquidated at (Blue) and WETH Price Over Time (Red)")
```
Here we can see that the difference in price of reserve between borrow and liquidation somewhat seems to model the fluctuation of the price of WETH itself, which makes sense. The gap in between the two lines is the price that the specific loan was liquidated at. As we can see, sometimes that price is very high, and sometimes it is much lower. Now I started wondering about the impact of price on the number of liquidations. My prediction was that when the price of WETH dropped very low, there would be a spike in liquidations.

```{r}
wethLiquidDateCounts <- wethLiquids %>%
  dplyr::group_by(as.Date(date)) %>%
  dplyr::summarise(date,n=n())

ggplot() +
  geom_line(data=wethPrice, aes(x=as.Date(date),y=reservePriceUSD), colour="red") + 
  geom_line(data=wethLiquidDateCounts, aes(x=as.Date(date),y=100*n), colour="blue",) +
  scale_x_date(date_labels="%m-%y") +
  scale_y_continuous("USD Price of WETH (red)", sec.axis=sec_axis(~ . * 0.01, name = "Number of Liquidations (blue)")) +
  xlab("Date") + 
  ggtitle("Price of WETH and Number of Liquidations by Date")
```
As we can see, the graph above confirms this hypothesis. There were more liquidations at the peak price, but that is most likely because of the China crypto ban that occurred around the same time. This further shows the impact of world events on cryptocurrency prices. Now I started thinking about individual users' liquidations, and I decided to standardize the number of liquidations each user had, so that we could find statistically significant liquidations, and analyze the characteristics about those loans so that we might get a better idea about what causes liquidations and what factors to consider when making a borrow.

```{r}
wethLiquidUserCounts <- wethLiquids %>%
  dplyr::count(user) %>%
  dplyr::arrange(n)

wethLiquidUserCounts <- wethLiquidUserCounts %>%
  dplyr::arrange(n) %>%
  dplyr::mutate(z=(n-mean(wethLiquidUserCounts$n))/sd(wethLiquidUserCounts$n))

ggplot(wethLiquidUserCounts, aes(x=z)) + geom_line(stat = "count")

stat.sig <- wethLiquidUserCounts %>%
  dplyr::filter(z>=2)

stat.sig
```
The dataframe above contains the names of users who had a statistically significant number of liquidations using WETH as the principal, and now we will graph the prices along the price curve of WETH.

```{r}
wethLiquids.sig <- wethLiquids %>%
  dplyr::filter(user %in% stat.sig$user)

ggplot() +
  geom_line(data=wethPrice, aes(x=as.Date(date),y=reservePriceUSD), colour="red") +
  geom_point(data=wethLiquids, aes(x=as.Date(date),y=reservePriceUSDPrincipal), colour="blue", shape=4) + 
  xlab("Date") +
  ylab("Price in USD") +
  ggtitle("Price at Which Liquidation Occurred")

ggplot() +
  geom_line(data=wethPrice, aes(x=as.Date(date),y=reservePriceUSD), colour="red") +
  geom_point(data=wethLiquids.sig, aes(x=as.Date(date),y=reservePriceUSDPrincipal), colour="blue", shape=4) + 
  xlab("Date") +
  ylab("Price in USD") +
  ggtitle("Price at Which Statistically Significant Liquidation Occurred")
```
As can be seen above, the first graph shows all liquidations that had WETH as the principal reserve borrowed, and the second graph showed all statistically significant liquidations, which was calculated as a liquidation that occurred to a user that had a number of liquidations that was within the top 95% of liquidated users. We can see that these statistically significant liquidations occur at the low points of the price curve, meaning that as the price drops, your probability of liquidating is much higher. This can be further modeled with a survival curve.

# Next Steps

My next steps are to dive deeper into the story of WETH and how it is transacted on the AAVE platform, as well as perform more survival analysis so that users who utilize the app can have the best chance of performing a safe borrow and not have to worry about liquidation. 

```{r}
wethSurvivalData <- left_join(wethBorrows,wethLiquids,by="name") %>%
  dplyr::rename(borrowDate=date.x) %>%
  dplyr::rename(liquidationDate=date.y) %>%
  dplyr::mutate(age=case_when(is.na(timestamp.y) ~ max(wethBorrows$timestamp)/86400,
                              TRUE ~ (timestamp.y-timestamp.x)/86400)) %>%
  dplyr::mutate(status=case_when(age==max(wethBorrows$timestamp)/86400 ~ 0,
                                 TRUE ~ 1)) %>%
  dplyr::filter(age>=0) %>%
  dplyr::select(name,age,status,borrowRateMode,collateralReserve)

km_fit <- survfit(Surv(age, status) ~ 1, data=wethSurvivalData)
summary(km_fit, times = c(1,30,60,90*(1:10)))
ggsurvplot(km_fit,conf.int=TRUE,xlim=c(0,250),ylim=c(0.87,1),break.time.by=25) +
  xlab("Time (Days)") +
  ggtitle("Survival of WETH Borrow until Liquidation")

km_fit_brm <- survfit(Surv(age, status) ~ borrowRateMode, data=wethSurvivalData)
summary(km_fit_brm, times = c(1,30,60,90*(1:10)))
ggsurvplot(km_fit_brm,conf.int=TRUE,xlim=c(0,250),ylim=c(0.87,1),break.time.by=25) +
  xlab("Time (Days)") +
  ggtitle("Survival of WETH Borrow until Liquidation by Borrow Rate Mode")

km_fit_cr <- survfit(Surv(age, status) ~ collateralReserve, data=wethSurvivalData %>%
                       dplyr::filter(collateralReserve %in% 
                                       #c("USDC","DAI","WBTC","LINK","WETH")))
                                       c("AAVE","LINK","XSHUSHI")))
summary(km_fit_cr, times = c(1,30,60,90*(1:10)))
ggsurvplot(km_fit_cr,legend.title="Collateral",legend.labs=c("AAVE","LINK","XSHUSHI")) +
  xlab("Time (Days)") +
  ggtitle("Survival of WETH Borrow until Liquidation by Collateral Reserve")

weth.surv.medians <- surv_median(km_fit_cr) %>%
  dplyr::arrange(median)

kable(weth.surv.medians)

weth.cox <- coxph(Surv(age, status) ~ collateralReserve, data=wethSurvivalData)
summary(weth.cox)
```

```{r}
allSurvivalData <- left_join(borrows,liquidations,by="name") %>%
  dplyr::mutate(age=case_when(is.na(timestamp.y) ~ max(borrows$timestamp)/86400,
                              TRUE ~ (timestamp.y-timestamp.x)/86400)) %>%
  dplyr::mutate(status=case_when(age==max(borrows$timestamp)/86400 ~ 0,
                                 TRUE ~ 1)) %>%
  dplyr::filter(age>=0) %>%
  dplyr::rename(collateralReserve=collateralReserve.y) %>%
  dplyr::rename(borrowRateMode=borrowRateMode.x) %>%
  dplyr::select(name,age,status,collateralReserve,borrowRateMode)

km_fit_all <- survfit(Surv(age, status) ~ 1, data=allSurvivalData)
summary(km_fit_all, times = c(1,30,60,90*(1:10)))
ggsurvplot(km_fit_all,conf.int=TRUE,xlim=c(0,250),ylim=c(0.3,1),break.time.by=25) +
  xlab("Time (Days)") +
  ggtitle("Survival of Borrow until Liquidation")

km_fit_brm_all <- survfit(Surv(age, status) ~ borrowRateMode, data=allSurvivalData)
summary(km_fit_brm_all, times = c(1,30,60,90*(1:10)))
ggsurvplot(km_fit_brm_all,conf.int=TRUE,xlim=c(0,21),ylim=c(0.87,1),break.time.by=1) +
  xlab("Time (Days)") +
  ggtitle("Survival of Borrow until Liquidation by Borrow Rate Mode")

km_fit_cr_all <- survfit(Surv(age, status) ~ collateralReserve, data=allSurvivalData %>%
                           dplyr::filter(collateralReserve %in% c("LINK","WBTC","WETH")))
summary(km_fit_cr_all, times = c(1,30,60,90*(1:10)))
ggsurvplot(km_fit_cr_all) +
  xlab("Time (Days)") +
  ggtitle("Survival of Borrow until Liquidation by Collateral Reserve")
```


