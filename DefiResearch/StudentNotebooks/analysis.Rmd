---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
#import libraries
if (!require("ggplot2")) {
  install.packages("ggplot2")
  library(ggplot2)
}
if (!require("knitr")) {
  install.packages("knitr")
  library(knitr)
}
if (!require("RColorBrewer")) {
  install.packages("RColorBrewer")
  library(RColorBrewer)
}
if (!require("tidyverse")) {
  install.packages("tidyverse")
  library(tidyverse)
}
if (!require("xts")) {
  install.packages("xts")
  library(xts)
}
if (!require("dplyr")) {
  install.packages("dplyr")
  library(dplyr)
}
if (!require("devtools")) {
  install.packages("devtools")
  library(devtools)
}
if (!require("ggfortify")) {
  install.packages("ggfortify")
  library(ggfortify)
}
if (!require("lubridate")) {
  install.packages("lubridate")
  library(lubridate)
}
if (!require("survival")) {
  install.packages("survival")
  library(survival)
}
if (!require("zoo")) {
  install.packages("zoo")
  library(zoo)
}
```

```{r}
borrows <- read_csv('../Data/borrows.csv')
deposits <- read_csv('../Data/deposits.csv')
raw_df <- read_rds('../Data/transactions.Rds')
```

```{r}
borrows <- raw_df %>%
  filter(type=="borrow")

deposits <- raw_df %>%
  filter(type=="deposit")

depositBorrow <- left_join(deposits,borrows,by="onBehalfOf") %>%
  dplyr::rename(depositTime=timestamp.x) %>%
  dplyr::rename(borrowTime=timestamp.y) %>%
  group_by(onBehalfOf) %>%
  dplyr::summarise(timeDiff=case_when(min(borrowTime)-min(depositTime)>0 ~ (min(borrowTime)-min(depositTime))/86400, TRUE ~ as.double(max(borrows$timestamp)/86400))) %>%
  mutate(status=case_when(timeDiff==max(borrows$timestamp)/86400 ~ 0, timeDiff>0 ~ 1, TRUE ~ 0)) %>%
  select(onBehalfOf,timeDiff,status)

depositBorrow
unique(depositBorrow$status)
```

```{r}
km <- with(depositBorrow, Surv(timeDiff, status))
head(km,80)
```

```{r}
km_fit <- survfit(Surv(timeDiff, status) ~ 1, data=depositBorrow)
summary(km_fit, times = c(1,30,60,90*(1:10)))
autoplot(km_fit,xlab="time (days)",ylab="Survival Rate",title="Survival Rate of Deposit before the first Borrow")
```

```{r}
usdc_borrows <- borrows %>%
  filter(reserve=="USDC") %>%
  select(onBehalfOf,timestamp) %>%
  dplyr::rename(user=onBehalfOf)

usdc_liquidations <- raw_df %>%
  filter(type=="liquidation" & principalReserve=="USDC") %>%
  select(user,timestamp)

usdc_borrowLiquid <- left_join(usdc_borrows,usdc_liquidations,by="user") %>%
  dplyr::rename(borrowTime=timestamp.x) %>%
  dplyr::rename(liquidTime=timestamp.y) %>%
  group_by(user) %>%
  dplyr::summarise(timeDiff=case_when(min(borrowTime)-min(liquidTime)>0 ~ min(borrowTime)-min(liquidTime), TRUE ~ as.integer(max(usdc_borrows$timestamp)))) %>%
  mutate(status=case_when(timeDiff>0 ~ 1, TRUE ~ 0)) %>%
  select(user,timeDiff,status)

usdc_borrowLiquid
unique(usdc_borrowLiquid$status)
```

```{r}
liquidations <- raw_df %>%
  filter(type=="liquidation")
```


```{r}
borrows2 <- raw_df %>%
  filter(type=="borrow") %>%
  select(onBehalfOf,borrowRateMode,borrowRate,reserve,amountUSD,timestamp) %>%
  dplyr::rename(user=onBehalfOf)

liquids <- raw_df %>%
  filter(type=="liquidation") %>%
  select(user)

liquidModes <- left_join(borrows2,liquids,by="user")

ggplot(liquidModes,aes(x=borrowRateMode)) + geom_bar()
```

```{r}
liquidStable <- liquidModes %>%
  filter(borrowRateMode=="Stable" & amountUSD <= 5000000 & borrowRate <= 20) %>%
  select(borrowRate,reserve,amountUSD,timestamp)

liquidVariable <- liquidModes %>%
  filter(borrowRateMode=="Variable" & amountUSD <= 25000000 & borrowRate <= 5) %>%
  select(borrowRate,reserve,amountUSD,timestamp)

ggplot(liquidStable,aes(x=reserve,y=borrowRate)) + geom_boxplot(outlier.shape=NA) + ggtitle("Borrow Rate for Every Stable Borrow that Liquidated by Reserve")
ggplot(liquidVariable,aes(x=reserve,y=borrowRate)) + geom_boxplot(outlier.shape=NA) + ggtitle("Borrow Rate for Every Variable Borrow that Liquidated by Reserve")

ggplot(liquidStable,aes(x=borrowRate,y=amountUSD)) + geom_point() + ggtitle("Amount USD vs Borrow Rate for every Stable Borrow that Liquidated")
ggplot(liquidVariable,aes(x=borrowRate,y=amountUSD)) + geom_point() + ggtitle("Amount USD vs Borrow Rate for every Variable Borrow that Liquidated")
```

```{r}
big_liquidVariable <- liquidVariable %>%
  filter(reserve=="USDC" | reserve=="USDT" | reserve=="DAI")

big_liquidStable <- liquidStable %>%
  filter(reserve=="USDC" | reserve=="USDT" | reserve=="DAI")

ggplot(big_liquidVariable,aes(x=borrowRate,y=amountUSD)) + geom_point() + ggtitle("Amount USD vs Borrow Rate for every Variable Borrow that Liquidated (Big 3)")
ggplot(big_liquidStable,aes(x=borrowRate,y=amountUSD)) + geom_point() + ggtitle("Amount USD vs Borrow Rate for every Stable Borrow that Liquidated (Big 3)")
```

```{r}
# calculate and graph a moving average of borrow rates that led to liquidation for both stable and variable borrows
roll_big_liquidStable <- big_liquidStable %>%
  dplyr::arrange(timestamp) %>%
  dplyr::mutate(rollingAvg=zoo::rollmean(borrowRate,k=1,fill=NA)) %>%
  dplyr::mutate(rollingAvg21=zoo::rollmean(borrowRate,k=21,fill=NA)) %>%
  dplyr::mutate(rollingAvg90=zoo::rollmean(borrowRate,k=90,fill=NA))

ggplot(roll_big_liquidStable, aes(x=as_datetime(timestamp),y=rollingAvg90)) + geom_line() + xlab("Date") + ylab("Average Borrow Rate") + ggtitle("90-Day Rolling Average for Stable Borrow Rates that Liquidated over Time")

roll_big_liquidVariable <- big_liquidVariable %>%
  dplyr::arrange(timestamp) %>%
  dplyr::mutate(rollingAvg=zoo::rollmean(borrowRate,k=1,fill=NA)) %>%
  dplyr::mutate(rollingAvg21=zoo::rollmean(borrowRate,k=21,fill=NA)) %>%
  dplyr::mutate(rollingAvg90=zoo::rollmean(borrowRate,k=90,fill=NA))

ggplot(roll_big_liquidVariable, aes(x=as_datetime(timestamp),y=rollingAvg90)) + geom_line() + xlab("Date") + ylab("Average Borrow Rate") + ggtitle("90-Day Rolling Average for Variable Borrow Rates that Liquidated over Time")
```


