---
title: "DAR Defi Team Assignment 2 (Fall 2021)"
subtitle: "DeFi Reserve Coins"
author: "Jason Podgorski"
date: "08/03/2021"
output:
  pdf_document: default
  html_document:
    toc: true
    number_sections: true
    df_print: paged
---

```{r setup, include=FALSE}
# Set the default CRAN repository
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})

# Set code chunk defaults
knitr::opts_chunk$set(echo = TRUE)

# Load required packages; install if necessary
# CAUTION: DO NOT interrupt R as it installs packages!!
if (!require("ggplot2")) {
  install.packages("ggplot2")
  library(ggplot2)
}
if (!require("knitr")) {
  install.packages("knitr")
  library(knitr)
}
if (!require("dplyr")) {
  install.packages("dplyr")
  library(dp)
}
if (!require("RColorBrewer")) {
  install.packages("RColorBrewer")
  library(RColorBrewer)
}
if (!require("beeswarm")) {
  install.packages("beeswarm")
  library(beeswarm)
}
if (!require("tidyverse")) {
  install.packages("tidyverse")
  library(tidyverse)
}
if (!require("ggbeeswarm")) {
  install.packages("ggbeeswarm")
  library(ggbeeswarm)
}
if (!require("xts")) {
  install.packages("xts")
  library(xts)
}
if (!require("igraph")) {
  install.packages("igraph")
  library(igraph)
}
if (!require("networkD3")) {
  install.packages("networkD3")
  library(networkD3)
}
if (!require("plotly")) {
  install.packages("plotly")
  library(plotly)
}
install.packages("webshot")
webshot::install_phantomjs()
```


# GITHUB UPDATE & SUBMISSION INSTRUCTIONS (Delete before submission!)

For this and subsequent assignments you'll follow the same basic github steps you used for Assignment 1, ie:

* **Option 1:** Update the copy of your team's repository currently in your home directory:
    * _This is the preferred option **if** you have already cloned the repositorya_
    * In the Linux terminal: `git pull origin master`
    * If there are errors, it's simplest to proceed to "Option 2"
    * If no errors, check your branch: `git branch` (should be something like `dar-rcsid`)
* **Option 2:** Get a fresh copy of your team's repository:
    * _Do this only if Option 1 fails!_
    * In Linux: `cd ~` to get to your login directory
    * In Linux: `rm -Rf IDEA-Blockchain` (deletes all your previous, uncommited work)
    * In Linux: `git clone https://github.rpi.edu/DataINCITE/IDEA-Blockchain.git`
    * In Linux: `cd IDEA-Blockchain` 
    * In Linux: Recreate a personal branch to save your changes to: `git checkout -b dar-rcsid` (replace "rcsid" with your rcsid!)
* Locate and save a personal copy of the assignment notebook:
    * In RStudio "Files" tab, navigate to: `Home > IDEA-Blockchain > DefiResearch > StudentNotebooks > Assignment02`
    * Double-click on `blockchain-assignment2-f21.Rmd` to open
    * Under the "File" menu, "Save as" something like `rcsid-assignment2-f21.Rmd` (replace "rcsid" with your rcsid!)
    * You should see your file appear in the "Files" tab, usually at the bottom
    * Under "More" in the "Files" tab, select "Set as working directory"
* Edit your notebook, saving as you make changes.
    * `cntl-S` works!
* "Knit" your notebook, generating a PDF file:
    * You should see your new PDF appear in the "Files" tab, usually at the bottom
    * "Export" your file (under the "More" menu in the "Files" tab) and save to your local file system
* Add your changed file(s) to your personal branch, and commit:
    * In Linux: `cd ~/IDEA-Blockchain/DefiResearch/StudentNotebooks/Assignment02`
    * In Linux: `git add rcsid-assignment2.*` (replace "rcsid" with your rcsid!)
    * In Linux: `git commit -m "rcsid assignment 2"`
* Push your changes to the remote repository:
    * In Linux: `git push origin dar-rcsid` (replace "rcsid" with your rcsid)
* Issue a pull request:
    * Navigate to https://github.rpi.edu/DataINCITE/IDEA-Blockchain in your browser
    * It should notify you of your recent push and prompt you to make a pull request.
    * If not, find your branch under the popup (defaults to **master**), select and click to issue a pull request
    * One of the instructors 
*  Upload your downloaded `rcsid-assignment2-f21.pdf` to LMS (replace "rcsid" with your rcsid)
*  **Be prepared to share your findings in the DeFi Meeting Thursday.**


# Prepare Transaction Data and Explore

We begin by loading our prepared AAVE transaction data into a dataframe. The dataset has over 400,000 rows, and 27 columns. 

We are directly loading the dataframe from an Rds archive instead of a CSV file to conserve space. 

```{r}
#load Rds (binary version of csv file) into dataframe
# Assumes this notebook is in: ~/IDEA-Blockchain/DefiResearch/StudentNotebooks/Assignment02
df<-read_rds('../../Data/transactions.Rds')

# Let's take a quick look at the first few observation
head(df)
```

Now look at the summaries to see the types, values, and missingness (NA's) of the data.

```{r}

summary(df)
```


First we'll do some preliminary analysis before we ask detailed questions.

## Analyze Transaction Types

Let's examine the different types of _transactions_ present in the data. We'll make a simple bar plot to visualize the number of each transaction types. "Deposit" is the most common type of transaction, whereas "swaps" are the most rare.

```{r}
#set color palette
colors = brewer.pal(6,"Set2")

#create barplot
barplot(table(df$type), main='Transaction Type Counts', xlab='Type',ylab='Count',col=colors)
```

There are more "deposits" than "borrows," because users often need to overcollateralize for loans. 

Now we'll examine the amount of US dollars being used in the different types of transactions. We create box plots for the four types of transactions that have the "amount" feature associated with them, and we visualize the distribution of that column for the different transactions. 

We can see that most transactions are completed with very little money. 

```{r}
#create boxplot
boxplot(amountUSD~type,data=df,outline=FALSE,col=colors,
        main="Transaction Amounts",xlab="Type",ylab="Amount (USD)")

```

We do find some very large amounts, so it's helpful to look at this on a log scale.

```{r}
boxplot(log(amountUSD)~type,data=df,outline=FALSE,col=colors,
        main="Log Transaction Amounts",xlab="Type",ylab="Log Amount (USD)")
```

Observation: _There are many borrows and repays with high transactions amounts, but deposits and redeems have much lower transactions amounts._

## Examine Reserve Coins  

There are 50 different "Reserve" coins used in transactions in AAVE.
Let's create a table of those reserve coins with at least 500 transactions and rank order them by their volume. 

```{r}
# Use deplyr to drop NA reserves, add the counts and then keep only the top 20
reservecoins <- df %>%  drop_na(reserve) %>% 
  count(reserve) %>% 
  arrange(-n) %>% 
  head(22)

# Add the rank to help keep track of the reserve coins
reservecoins <- reservecoins %>% 
  mutate(rank=1:nrow(reservecoins),.before=reserve)

# List the results nicely with kable()
kable(reservecoins)

```

Let's look at the number of transactions types for each currency. 

```{r}

TopcoinSummary <- df %>% filter(reserve %in% reservecoins$reserve) %>%
  group_by(reserve) %>% 
  count(type) %>% 
  mutate(percent = n/sum(n)*100)

kable(TopcoinSummary) 

```


## Look at Sample User Transaction Histories 

Finally, we will examine the transaction history of different users. To do this, we will select 3 random users from the data who have completed between 100 and 300 transactions. Then, we create swarmplots displaying the different types of transactions those users made over time.

```{r,fig.width=16,fig.height=8}
#set seed
set.seed(1)

# Select three random users that have between 100 and 300 transactions
users<-vector(length=3)
count<-0
while(count<=3){
  success<-FALSE
  while(!success){
    #get random user
    ruser<-sample(df$user,1)
    
    #check for valid number of transactions
    length<-nrow(filter(df,user==ruser))
    if (length>100 && length<300){
      users[count]=ruser
      success<-TRUE
      count<-count+1
    }
  }
}
df.rusers<-filter(df, user %in%users)

# Create a "swarmplot"

ggplot(df.rusers,aes(user, timestamp,color=type)) + 
        geom_beeswarm(cex=1)+
        coord_flip()+
        ggtitle("User Transaction History")

```

Observation: _Users have very different transactions patterns, which we will try to better understand. _


# Activities
##$\color{blue}{Exercise~1} (10 pts)$  

1. Divide the top 20 reserve coins between your team members so each team member has the same amount of coins; feel free to add or subtract coins if necessary.

2. Look up your coins on the internet to find out what they are.  ProTip: Look them up on http://defipulse.com to see their _Total Value Locked (TVL)_.

3. Examine the percentage of transaction types for your coins.  Hypothesize why a given coin might have more of one type of transaction than another.

4. _Prepare one slide with the findings for each of your coins._ (one slide summarizing each coin)

5. Coordinate with your team, to combine each of your member's coin descriptions into a single presentation.  Please develop a common format or template for presenting your coin summaries so that the common information for a coin (e.g. TVL) is shown in the same format. (Your slide summaries should look the same!)

6. Be prepared to present your team presentation to your client in class on Thursday 9/16.

```{r}
usdt_df <- df[df$reserve == "USDT", ]
boxplot(amountUSD~type,data=usdt_df,outline=FALSE,col=colors,
        main="Transaction Amounts",xlab="Type",ylab="Amount (USD)")
```


```{r}
TopcoinSummary[TopcoinSummary$reserve == 'USDT',]
TopcoinSummary[TopcoinSummary$reserve == 'WBTC',]
TopcoinSummary[TopcoinSummary$reserve == 'XSUSHI',]
```


```{r}
wbtc_df <- df[df$reserve == "WBTC", ]
boxplot(amountUSD~type,data=wbtc_df,outline=FALSE,col=colors,
        main="Transaction Amounts",xlab="Type",ylab="Amount (USD)")
```


```{r}
xsushi_df <- df[df$reserve == "XSUSHI", ]
boxplot(amountUSD~type,data=xsushi_df,outline=FALSE,col=colors,
        main="Transaction Amounts",xlab="Type",ylab="Amount (USD)")
```


##$\color{blue}{Exercise~2} (10 pts)$ 

1. Perform a "creative exploration" of some aspect of the Defi data that you find interesting.   Add your work in this notebook. _Your work should include at least one data visualization._

2. Put your work in this notebook.

3. Write a paragraph describing your findings in the context of DeFi. 

4. Be prepared to share (2 minutes) in team meeting.

5. _You'll receive extra credit for work that goes "above and beyond" this assignment! _


```{r}
# Use above code to generate random users onBehalfOf

#set seed
set.seed(10)

# Select three random users that have between 100 and 300 transactions
users<-vector(length=3)
count<-0
while(count<=3){
  success<-FALSE
  while(!success){
    #get random user
    ruser<-sample(df$onBehalfOf,1)
    
    #check for valid number of transactions
    length<-nrow(filter(df,onBehalfOf==ruser))
    if (length>100 && length<300){
      users[count]=ruser
      success<-TRUE
      count<-count+1
    }
  }
}
randUsers<-filter(df, onBehalfOf %in%users)
randUsers <- randUsers[order(randUsers$onBehalfOf),]
head(randUsers)
```


```{r}
#Network Graph of 1 random individual and the reserves they made transactions with
person <- unique(randUsers$onBehalfOf)[1]
person_df <- randUsers[randUsers$onBehalfOf == person,]
f <- c(as.character(person_df$reserve[1]))
t <- c()
for (i in 2:(nrow(person_df)-1)) {
  f[i] = as.character(person_df$reserve[i])
  t[i-1] = as.character(person_df$reserve[i])
}
t[i] = as.character(person_df$reserve[nrow(person_df)])

data <- tibble(
  from = f,
  to = t
)

#Plot
p <- simpleNetwork(data, height="100px", width="100px",        
        Source = 1,
        Target = 2,
        linkDistance = 10,
        charge = -900,               
        fontSize = 14,
        fontFamily = "serif",
        zoom = T)
p
```


```{r}
#Network Graph of 3 random individuals and the reserves they made transactions with
f <- c(as.character(randUsers$reserve[1]))
t <- c()
for (i in 2:(nrow(randUsers)-1)) {
  f[i] = as.character(randUsers$reserve[i])
  t[i-1] = as.character(randUsers$reserve[i])
}
t[i] = as.character(randUsers$reserve[nrow(randUsers)])

data <- tibble(
  from = f,
  to = t
)

# Plot
p <- simpleNetwork(data, height="100px", width="100px",        
        Source = 1,
        Target = 2,
        linkDistance = 10,
        charge = -900,               
        fontSize = 14,
        fontFamily = "serif",
        zoom = T
        )
p
```

```{r}
# Attempt to create Plotly line chart with transaction history for an individual user
# filtered by coin, I messed around with it for many hours but couldn't quite get it to work

df_sort <- df.rusers[order(df.rusers$timestamp),]
dropdown <- list()
num_coins <- length(unique(as.character(df_sort$reserve))) 
for (i in 1:num_coins) {
  coin <- unique(as.character(df_sort$reserve))[i]
  time <- df_sort[df_sort$reserve == coin,]$timestamp
  y__ <- df_sort[df_sort$reserve == coin,]$amount
  data <- data.frame(time, y__)
  scatter_fig <- plot_ly(data, x = ~time, type = "scatter", mode = "lines+markers")
  if (i == 1) {
    scatter_fig <- scatter_fig %>% add_lines(y = ~y__, color = ~df_sort[df_sort$reserve == coin,]$type, name = ~df_sort[df_sort$reserve == coin,]$type)
  } else {
    scatter_fig <- scatter_fig %>% add_lines(y = ~y__, color = ~df_sort[df_sort$reserve == coin,]$type, name = ~df_sort[df_sort$reserve == coin,]$type)
  }
  if (i == 1) {
    dropdown <- c(dropdown, list(list(method = "update", args = list("visible", c(list(T), rep(F, each = num_coins - 1))), label = coin)))
  } else {
   dropdown <- c(dropdown, list(list(method = "update", args = list("visible", c(rep(F, each = i - 1), list(T), rep(F, each = num_coins - i))), label = coin)))
  }
}

scatter_fig <- scatter_fig %>% layout(
  title = "Transactions By Coin",
  updatemenus = list(
    list(
      y = 0.9,
      buttons = dropdown 
    )
  )
)

scatter_fig
```

```{r}
# This is what the previous plot is supposed to look like without the filtering

df_sort <- df.rusers[order(df.rusers$timestamp),]

time <- df_sort[df_sort$reserve == "WBTC",]$timestamp
amount <- df_sort[df_sort$reserve == "WBTC",]$amount

data <- data.frame(time, amount)

fig <- plot_ly(data, x = ~time, y = ~amount, type = 'scatter', color = ~df_sort[df_sort$reserve == "WBTC",]$type, name = ~df_sort[df_sort$reserve == "WBTC",]$type, mode = 'lines+markers') %>%
        layout(title = "WBTC")

fig
```
Findings

My first set of plots are network graphs using the NetworkD3 package. The purpose of these plots is to encompass an individual's transaction history by specific coin. I wanted to visualize the volume of transactions for each coin as well as a general sense for order of how these transaction occurred. From the first plot, you can see the individual spent a lot time with the cluster on the right (SUSD, CRV, SNX, DAI, USDC) and then gradually moved over to some coins on the left side of the network as time went on. The goal of this was to visualize what types of coins were related based on the time frame the user interacted with them. The other network plot deals with three random individuals instead of one.

My next set of plots were line charts using Plotly. This was again based on an individual's transactions with a coin. I wanted to see the order of different types of transactions as well an amount associated with each one. My goal was to make it filterable so that we could see all the coins the individual has ever interacted with but I could not get the filtering to work properly. Looking at the second line chart, we can see the individual made many deposits and redeems in WBTC and spiked in activity towards the middle of their time interacting with the coin. It would be interesting to also equate these transactions with the value of the coin.
