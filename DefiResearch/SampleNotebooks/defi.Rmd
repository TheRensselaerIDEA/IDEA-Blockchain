---
title: "R Notebook"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

# DefiResearch

```{r}
#load libraries
library(ggplot2)
library(RColorBrewer)
library(beeswarm)
library(tidyverse)
library(ggbeeswarm)
library(xts)
```

# Prepare Transaction Data

We begin by loading in the data to a csv file. The dataset has over 400,000 rows, and 27 columns. 

```{r}
#load csv file in to dataframe
df<-read_csv(file='transactions.csv')
df
```
# Analyze Transaction Types

Next, we will examine the different types of transactions present in the data. We make a bar plot to visualize the number of each transaction types. Deposit is the most common type of transaction, whereas swaps are the most rare.

```{r}
#set color palette
colors = brewer.pal(6,"Set2")

#create barplot
barplot(table(df$type), main='Transaction Type Counts', xlab='Type',ylab='Count',col=colors)
```
There are more deposits than borrows, because users often need to overcollateralize for loans. 


Now, we will examine the amount of US dollars being used in the different types of transactions. We create box plots for the 4 types of transactions that have the amount feature associated with them, and visualize the distribution of that column for the different transactions. We can see that most transactions are completed with very little money. 

```{r}
#create boxplot
boxplot(amountUSD~type,data=df,outline=FALSE,col=colors,main="Transaction Amounts",xlab="Type",ylab="Amount (USD)")

```
```{r}
boxplot(log(amountUSD)~type,data=df,outline=FALSE,col=colors,main="Log Transaction Amounts",xlab="Type",ylab="Log Amount (USD)")
```
There are many borrows and repays with high transactions amounts, but deposits and redeems have much lower transactions amounts.



# Look at Sample User Transaction Histories 

Finally, we will examine the transaction history of different users. To do this, we will select 3 random users from the data who have completed between 100 and 300 transactions. Then, we create swarmplots displaying the different types of transactions those users made over time.

```{r,fig.width=16,fig.height=8}
#set seed
set.seed(1)

#get 3 random users that have between 100 and 300 transactions
users<-vector(length=3)
count<-0
while(count<=3){
  success<-FALSE
  while(!success){
    #get random user
    ruser<-sample(df$user,1)
    
    #check for valid number of transactions
    length<-nrow(filter(df,user==ruser))
    if (length>100 && length<300){
      users[count]=ruser
      success<-TRUE
      count<-count+1
    }
  }
}
df.rusers<-filter(df, user %in%users)

#create swarmplot

#liquidations
#borrow
#deposit
#redeem
#repay
#swap

ggplot(df.rusers,aes(user, timestamp,color=type)) + 
        geom_beeswarm(cex=1)+
        coord_flip()+
        ggtitle("User Transaction History")

```
Users have very different transactions patterns, which we will try to better understand. 

# Analyze Individual Currencies (USDT)

USDT is interesting because it has more borrows than deposits. This may be because it is a stable coin. 

```{r}

df.usd<-filter(df,reserve=="USDT")
barplot(table(df.usd$type), main='Transaction Type Counts', xlab='Type',ylab='Count',col=colors)
```

